stages: [trigger_nlp, plan, apply]

trigger_nlp:
  stage: trigger_nlp
  trigger:
    include:
      - local: "ci/nlp.yml"
    strategy: depend
  rules:
    - when: always

apigw_plan:
  stage: plan
  image:
    name: hashicorp/terraform:1.7.5
    entrypoint: [""]
  variables:
    TF_APIGW_DIR: "modules/apigateway"   
  script:
    - cd "$TF_APIGW_DIR"
    - terraform init -input=false \
      -backend-config="bucket=${TF_STATE_BUCKET}" \
      -backend-config="key=${TF_APIGW_STATE_KEY}" \
      -backend-config="region=${AWS_REGION}"

    # Read NLP endpoint from SSM (so apigw knows where to route)
    - terraform plan -out=tfplan
  artifacts:
    paths:
      - $TF_APIGW_DIR/tfplan
    expire_in: 1 day

apigw_apply:
  stage: apply
  when: manual
  dependencies: [apigw_plan]
  image:
    name: hashicorp/terraform:1.7.5
    entrypoint: [""]
  variables:
    TF_APIGW_DIR: "modules/apigateway"
  script:
    - cd "$TF_APIGW_DIR"
    - terraform init -input=false \
      -backend-config="bucket=${TF_STATE_BUCKET}" \
      -backend-config="key=${TF_APIGW_STATE_KEY}" \
      -backend-config="region=${AWS_REGION}"
    - terraform apply -auto-approve tfplan
